<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Bài tập - English with Thành Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="dashboard.html" class="text-gray-600 hover:text-indigo-600">
                <i class="fas fa-arrow-left mr-2"></i> Quay lại Dashboard
            </a>
            <div>
                <span id="user-display-name" class="text-gray-700 mr-4"></span>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Đăng xuất</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="loading-state" class="text-center">
            <p class="text-lg text-gray-600">Đang tải chi tiết bài tập...</p>
        </div>

        <div id="main-content" class="hidden">
            <h1 id="assignment-title" class="text-3xl font-bold text-gray-800"></h1>
            <p id="assignment-deadline" class="text-md text-red-600 font-semibold mt-2 mb-8"></p>

            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Các học phần cần hoàn thành:</h2>
                <div id="modules-list" class="space-y-3">
                    </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCRaRV5JEwXlHWSPSrCYxyIIPjDWFMsV9A",
            authDomain: "ielts-foundation-6ea9d.firebaseapp.com",
            projectId: "ielts-foundation-6ea9d",
            storageBucket: "ielts-foundation-6ea9d.appspot.com",
            messagingSenderId: "296690693780",
            appId: "1:296690693780:web:f9a54a9ded68a73dcd2681"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const loadingState = document.getElementById('loading-state');
        const mainContent = document.getElementById('main-content');
        const userDisplayName = document.getElementById('user-display-name');
        const assignmentTitle = document.getElementById('assignment-title');
        const assignmentDeadline = document.getElementById('assignment-deadline');
        const modulesList = document.getElementById('modules-list');
        const logoutButton = document.getElementById('logout-button');

        auth.onAuthStateChanged(async user => {
            if (user) {
                userDisplayName.textContent = user.displayName || user.email;
                await loadAssignmentDetails(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadAssignmentDetails(userId) {
            try {
                // 1. Lấy ID bài tập từ URL
                const urlParams = new URLSearchParams(window.location.search);
                const assignmentId = urlParams.get('id');

                if (!assignmentId) {
                    throw new Error("Không tìm thấy ID bài tập trong URL.");
                }

                // 2. Tải thông tin chi tiết của bài tập
                const assignmentDoc = await db.collection('assignments').doc(assignmentId).get();
                if (!assignmentDoc.exists) {
                    throw new Error("Bài tập không tồn tại.");
                }
                const assignmentData = assignmentDoc.data();

                // 3. Tải thông tin các học phần thuộc bài tập này
                const moduleIds = assignmentData.moduleIds;
                if (!moduleIds || moduleIds.length === 0) {
                    modulesList.innerHTML = '<p>Bài tập này không có học phần nào.</p>';
                    return;
                }
                
                // Dùng query 'in' để lấy tất cả các module cần thiết trong 1 lần gọi
                const modulesSnap = await db.collection('modules').where(firebase.firestore.FieldPath.documentId(), 'in', moduleIds).get();
                const modules = modulesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 4. (Tùy chọn) Tải tiến độ của học sinh với bài tập này để biết học phần nào đã hoàn thành
                // Hiện tại, chúng ta sẽ để mặc định là "Bắt đầu"
                
                // 5. Hiển thị mọi thứ ra giao diện
                assignmentTitle.textContent = assignmentData.title;
                const deadline = assignmentData.deadline.toDate(); // Dùng đúng trường 'deadline'
                assignmentDeadline.textContent = `Hạn chót: ${deadline.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

                modulesList.innerHTML = ''; // Xóa placeholder
                modules.forEach(module => {
                    const moduleEl = document.createElement('a');
                    // Tạo link đến trang học bài, truyền cả assignmentId và moduleId (trước đây là vocabId)
                    moduleEl.href = `vocab_app.html?assignmentId=${assignmentId}&vocabId=${module.id}`;
                    moduleEl.className = 'flex justify-between items-center p-4 border rounded-lg hover:bg-gray-50 transition-colors';
                    
                    moduleEl.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-book-open text-indigo-500 mr-4"></i>
                            <span class="font-semibold text-gray-700">${module.title}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-indigo-600 font-semibold mr-2">Bắt đầu</span>
                            <i class="fas fa-arrow-right text-indigo-600"></i>
                        </div>
                    `;
                    modulesList.appendChild(moduleEl);
                });

            } catch (error) {
                console.error("Lỗi khi tải chi tiết bài tập:", error);
                mainContent.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            } finally {
                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>
