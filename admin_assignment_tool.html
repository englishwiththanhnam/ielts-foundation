<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C√¥ng c·ª• Giao B√†i T·∫≠p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Be Vietnam Pro', sans-serif; } 
        .module-row { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        fieldset:disabled { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <h1 class="text-3xl font-bold text-indigo-600 mb-2">C√¥ng c·ª• Giao B√†i T·∫≠p</h1>
        <p class="text-gray-600 mb-8">T·∫°o v√† g√°n b√†i t·∫≠p v·ªÅ nh√† cho c√°c l·ªõp h·ªçc.</p>

        <div class="space-y-6">
            <div>
                <label for="firebaseConfig" class="block text-sm font-medium text-gray-700 mb-1">1. D√°n Firebase Config:</label>
                <textarea id="firebaseConfig" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="const firebaseConfig = {...};"></textarea>
                <button id="connect-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-all">
                    K·∫øt n·ªëi & T·∫£i d·ªØ li·ªáu
                </button>
            </div>
            
            <fieldset id="assignment-form" disabled>
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Th√¥ng tin B√†i t·∫≠p</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn l·ªõp h·ªçc:</label>
                            <select id="class-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label>
                            <input type="text" id="assignment-title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: B√†i t·∫≠p v·ªÅ nh√† ng√†y 02/08/2025">
                        </div>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">3. C√°c h·ªçc ph·∫ßn</h2>
                        <button id="add-module-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold">
                            + Th√™m h·ªçc ph·∫ßn
                        </button>
                    </div>
                    <div id="modules-container" class="space-y-4">
                        <!-- C√°c h·ªçc ph·∫ßn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <button id="create-assignment-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all text-lg">
                    T·∫°o B√†i T·∫≠p
                </button>
            </fieldset>

            <div id="status" class="mt-4 p-4 bg-gray-50 rounded-md border border-gray-200 text-sm">
                Tr·∫°ng th√°i: Ch∆∞a k·∫øt n·ªëi. Vui l√≤ng d√°n Firebase Config v√† nh·∫•n n√∫t k·∫øt n·ªëi.
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        let db;
        let tests = [];
        let vocabSets = [];

        function initializeFirebase() {
            if (db) return true;
            const configText = document.getElementById('firebaseConfig').value;
            if (!configText) { alert("Vui l√≤ng d√°n Firebase Config!"); return false; }
            try {
                const firebaseConfig = new Function(`${configText} return firebaseConfig;`)();
                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                db = firebase.firestore();
                document.getElementById('status').innerText = 'Tr·∫°ng th√°i: ƒê√£ k·∫øt n·ªëi Firebase. S·∫µn s√†ng.';
                return true;
            } catch (error) {
                alert("L·ªói c√∫ ph√°p trong Firebase Config."); console.error(error); return false;
            }
        }

        async function loadInitialData() {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML += '<br>ƒêang t·∫£i danh s√°ch l·ªõp h·ªçc, b√†i thi v√† b·ªô t·ª´ v·ª±ng...';

            // T·∫£i song song
            const [classesSnap, testsSnap, vocabSetsSnap] = await Promise.all([
                db.collection("classes").get(),
                db.collection("tests").get(),
                db.collection("vocab_sets").get()
            ]);

            // X·ª≠ l√Ω L·ªõp h·ªçc
            const classSelector = document.getElementById('class-selector');
            classSelector.innerHTML = '<option value="">-- Ch·ªçn m·ªôt l·ªõp --</option>';
            classesSnap.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.data().className || doc.id;
                classSelector.appendChild(option);
            });

            // L∆∞u d·ªØ li·ªáu b√†i thi v√† t·ª´ v·ª±ng
            tests = testsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            vocabSets = vocabSetsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            statusEl.innerHTML += `<br>‚úÖ T·∫£i xong: ${classesSnap.size} l·ªõp, ${tests.length} b√†i thi, ${vocabSets.length} b·ªô t·ª´ v·ª±ng.`;
        }
        
        function createModuleRow() {
            const container = document.getElementById('modules-container');
            const newRow = document.createElement('div');
            newRow.className = 'module-row grid grid-cols-1 md:grid-cols-10 gap-4 items-center bg-gray-50 p-3 rounded-lg';
            
            newRow.innerHTML = `
                <div class="md:col-span-3">
                    <select class="module-type w-full p-2 border border-gray-300 rounded-md">
                        <option value="">-- Ch·ªçn lo·∫°i h·ªçc ph·∫ßn --</option>
                        <option value="test">B√†i Ki·ªÉm Tra</option>
                        <option value="vocab">√în T·ª´ V·ª±ng</option>
                    </select>
                </div>
                <div class="md:col-span-6">
                    <select class="module-id w-full p-2 border border-gray-300 rounded-md" disabled>
                        <option>-- Ch·ªçn n·ªôi dung --</option>
                    </select>
                </div>
                <div class="md:col-span-1 text-right">
                    <button class="remove-module-btn bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded-full w-8 h-8 flex items-center justify-center">
                        &times;
                    </button>
                </div>
            `;
            container.appendChild(newRow);
        }

        document.getElementById('modules-container').addEventListener('change', (e) => {
            if (e.target.classList.contains('module-type')) {
                const type = e.target.value;
                const idSelector = e.target.closest('.module-row').querySelector('.module-id');
                idSelector.innerHTML = '<option value="">-- Ch·ªçn n·ªôi dung --</option>';
                idSelector.disabled = true;

                let options = [];
                if (type === 'test') {
                    options = tests;
                } else if (type === 'vocab') {
                    options = vocabSets;
                }

                if (options.length > 0) {
                    options.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.title || item.id;
                        idSelector.appendChild(option);
                    });
                    idSelector.disabled = false;
                }
            }
        });
        
        document.getElementById('modules-container').addEventListener('click', (e) => {
            if (e.target.closest('.remove-module-btn')) {
                e.target.closest('.module-row').remove();
            }
        });

        document.getElementById('add-module-btn').addEventListener('click', createModuleRow);

        document.getElementById('create-assignment-btn').addEventListener('click', async () => {
            if (!db) {
                alert("Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc.");
                return;
            }

            const classId = document.getElementById('class-selector').value;
            const title = document.getElementById('assignment-title').value;
            const statusEl = document.getElementById('status');

            if (!classId || !title) {
                alert("Vui l√≤ng ch·ªçn l·ªõp v√† nh·∫≠p ti√™u ƒë·ªÅ b√†i t·∫≠p.");
                return;
            }

            const modules = [];
            const moduleRows = document.querySelectorAll('.module-row');
            if (moduleRows.length === 0) {
                alert("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt h·ªçc ph·∫ßn.");
                return;
            }

            for (const row of moduleRows) {
                const type = row.querySelector('.module-type').value;
                const id = row.querySelector('.module-id').value;
                if (!type || !id) {
                    alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin cho t·∫•t c·∫£ c√°c h·ªçc ph·∫ßn.");
                    return;
                }
                
                let moduleTitle = '';
                let url = '';
                if (type === 'test') {
                    const selectedTest = tests.find(t => t.id === id);
                    moduleTitle = selectedTest.title || id;
                    url = `reading_test.html?testId=${id}`;
                } else if (type === 'vocab') {
                    const selectedVocab = vocabSets.find(v => v.id === id);
                    moduleTitle = selectedVocab.title || id;
                    url = `vocab_app.html?vocabId=${id}`;
                }

                modules.push({ type, title: moduleTitle, url });
            }

            const assignmentData = {
                classId: classId,
                title: title,
                assignmentDate: firebase.firestore.FieldValue.serverTimestamp(),
                modules: modules
            };

            try {
                statusEl.textContent = `ƒêang t·∫°o b√†i t·∫≠p "${title}" cho l·ªõp ${classId}...`;
                const docRef = await db.collection("assignments").add(assignmentData);
                statusEl.innerHTML += `<br>üéâ **TH√ÄNH C√îNG!** ƒê√£ t·∫°o b√†i t·∫≠p v·ªõi ID: ${docRef.id}`;
                alert('T·∫°o b√†i t·∫≠p th√†nh c√¥ng!');
            } catch (error) {
                statusEl.textContent = `L·ªói: ${error.message}`;
                console.error(error);
            }
        });
        
        // [THAY ƒê·ªîI] G·∫Øn s·ª± ki·ªán v√†o n√∫t b·∫•m thay v√¨ window.onload
        document.getElementById('connect-btn').addEventListener('click', async (event) => {
            const connectButton = event.target;
            const statusEl = document.getElementById('status');
            const form = document.getElementById('assignment-form');

            connectButton.disabled = true;
            connectButton.textContent = 'ƒêang k·∫øt n·ªëi...';

            if (initializeFirebase()) {
                await loadInitialData();
                form.disabled = false; // M·ªü kh√≥a form
                statusEl.innerHTML += '<br>‚úÖ S·∫µn s√†ng ƒë·ªÉ t·∫°o b√†i t·∫≠p.';
                connectButton.textContent = 'ƒê√£ k·∫øt n·ªëi & T·∫£i xong!';
                connectButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                connectButton.classList.add('bg-gray-400');
            } else {
                statusEl.textContent = 'K·∫øt n·ªëi th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i Firebase Config.';
                connectButton.disabled = false;
                connectButton.textContent = 'Th·ª≠ l·∫°i';
            }
        });
    </script>
</body>
</html>
