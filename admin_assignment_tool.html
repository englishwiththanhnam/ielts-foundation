<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C√¥ng c·ª• Giao B√†i T·∫≠p v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Be Vietnam Pro', sans-serif; } 
        fieldset:disabled { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
        <h1 class="text-3xl font-bold text-indigo-600 mb-2">C√¥ng c·ª• Giao B√†i T·∫≠p v2.0</h1>
        <p class="text-gray-600 mb-8">Giao b√†i t·∫≠p t·ª´ gi√°o tr√¨nh g·ªëc v√† c√°c h·ªçc ph·∫ßn b·ªï sung.</p>

        <div class="space-y-6">
            <div>
                <label for="firebaseConfig" class="block text-sm font-medium text-gray-700 mb-1">1. D√°n Firebase Config v√† K·∫øt n·ªëi:</label>
                <textarea id="firebaseConfig" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="const firebaseConfig = {...};"></textarea>
                <button id="connect-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-all">
                    K·∫øt n·ªëi & T·∫£i d·ªØ li·ªáu
                </button>
            </div>
            
            <fieldset id="assignment-form" disabled>
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Th√¥ng tin B√†i t·∫≠p</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn l·ªõp h·ªçc:</label>
                            <select id="class-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label>
                            <input type="text" id="assignment-title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: B√†i t·∫≠p v·ªÅ nh√† ng√†y 02/08/2025">
                        </div>
                    </div>
                </div>

                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">3. Ch·ªçn H·ªçc Ph·∫ßn ƒê·ªÉ Giao</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 id="core-modules-title" class="font-bold text-gray-700 mb-2">H·ªçc ph·∫ßn trong Gi√°o tr√¨nh</h3>
                            <div id="core-modules-container" class="space-y-2 p-4 bg-gray-50 rounded-md border h-64 overflow-y-auto">
                                <p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt l·ªõp h·ªçc ƒë·ªÉ xem c√°c h·ªçc ph·∫ßn.</p>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-700 mb-2">H·ªçc ph·∫ßn B·ªï sung</h3>
                            <div id="supplementary-modules-container" class="space-y-2 p-4 bg-gray-50 rounded-md border h-64 overflow-y-auto">
                                <!-- H·ªçc ph·∫ßn b·ªï sung s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                            </div>
                        </div>
                    </div>
                </div>

                <button id="create-assignment-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all text-lg">
                    T·∫°o B√†i T·∫≠p
                </button>
            </fieldset>

            <div id="status" class="mt-4 p-4 bg-gray-50 rounded-md border border-gray-200 text-sm">
                Tr·∫°ng th√°i: Ch∆∞a k·∫øt n·ªëi.
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        let db;
        let classes = [];
        let supplementaryModules = [];

        function initializeFirebase() {
            if (db) return true;
            const configText = document.getElementById('firebaseConfig').value;
            if (!configText) { alert("Vui l√≤ng d√°n Firebase Config!"); return false; }
            try {
                const firebaseConfig = new Function(`${configText} return firebaseConfig;`)();
                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                db = firebase.firestore();
                document.getElementById('status').innerText = 'Tr·∫°ng th√°i: ƒê√£ k·∫øt n·ªëi Firebase.';
                return true;
            } catch (error) {
                alert("L·ªói c√∫ ph√°p trong Firebase Config."); console.error(error); return false;
            }
        }

        async function loadInitialData() {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML += '<br>ƒêang t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu...';

            const [classesSnap, supplementarySnap] = await Promise.all([
                db.collection("classes").get(),
                db.collection("supplementary_modules").get()
            ]);

            classes = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            supplementaryModules = supplementarySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const classSelector = document.getElementById('class-selector');
            classSelector.innerHTML = '<option value="">-- Ch·ªçn m·ªôt l·ªõp --</option>';
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.className || c.id;
                classSelector.appendChild(option);
            });

            const supplementaryContainer = document.getElementById('supplementary-modules-container');
            supplementaryContainer.innerHTML = supplementaryModules.map(m => `
                <label class="flex items-center p-2 rounded hover:bg-gray-100">
                    <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" value="${m.id}" data-type="supplementary">
                    <span class="ml-3 text-sm text-gray-800">${m.title}</span>
                </label>
            `).join('');
            
            statusEl.innerHTML += `<br>‚úÖ T·∫£i xong: ${classes.length} l·ªõp, ${supplementaryModules.length} h·ªçc ph·∫ßn b·ªï sung.`;
        }
        
        document.getElementById('class-selector').addEventListener('change', async (e) => {
            const classId = e.target.value;
            const coreContainer = document.getElementById('core-modules-container');
            const coreTitle = document.getElementById('core-modules-title');
            
            if (!classId) {
                coreTitle.textContent = 'H·ªçc ph·∫ßn trong Gi√°o tr√¨nh';
                coreContainer.innerHTML = '<p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt l·ªõp h·ªçc.</p>';
                return;
            }

            coreContainer.innerHTML = '<p>ƒêang t·∫£i h·ªçc ph·∫ßn c·ªßa l·ªõp...</p>';
            const selectedClass = classes.find(c => c.id === classId);
            if (!selectedClass || !selectedClass.curriculumId) {
                coreTitle.textContent = 'H·ªçc ph·∫ßn trong Gi√°o tr√¨nh';
                coreContainer.innerHTML = '<p class="text-gray-500">L·ªõp n√†y ch∆∞a ƒë∆∞·ª£c g√°n gi√°o tr√¨nh.</p>';
                return;
            }

            try {
                const curriculumDoc = await db.collection('curriculums').doc(selectedClass.curriculumId).get();
                const curriculumName = curriculumDoc.data()?.name || 'Kh√¥ng r√µ';
                coreTitle.textContent = `H·ªçc ph·∫ßn trong Gi√°o tr√¨nh: ${curriculumName}`;

                const modulesSnap = await db.collection('curriculums').doc(selectedClass.curriculumId).collection('modules').get();
                if (modulesSnap.empty) {
                    coreContainer.innerHTML = '<p class="text-gray-500">Gi√°o tr√¨nh n√†y ch∆∞a c√≥ h·ªçc ph·∫ßn n√†o.</p>';
                    return;
                }
                
                coreContainer.innerHTML = modulesSnap.docs.map(doc => {
                    const module = doc.data();
                    return `<label class="flex items-center p-2 rounded hover:bg-gray-100">
                                <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" value="${doc.id}" data-type="core">
                                <span class="ml-3 text-sm text-gray-800">${module.title}</span>
                            </label>`;
                }).join('');
            } catch (error) {
                console.error("L·ªói t·∫£i h·ªçc ph·∫ßn c·ªßa gi√°o tr√¨nh:", error);
                coreContainer.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
            }
        });

        document.getElementById('create-assignment-btn').addEventListener('click', async () => {
            if (!db) {
                alert("Vui l√≤ng k·∫øt n·ªëi Firebase tr∆∞·ªõc.");
                return;
            }

            const classId = document.getElementById('class-selector').value;
            const title = document.getElementById('assignment-title').value;
            const statusEl = document.getElementById('status');

            if (!classId || !title) {
                alert("Vui l√≤ng ch·ªçn l·ªõp v√† nh·∫≠p ti√™u ƒë·ªÅ b√†i t·∫≠p.");
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc ph·∫ßn ƒë·ªÉ giao.");
                return;
            }

            const modules = [];
            for (const checkbox of selectedCheckboxes) {
                const moduleId = checkbox.value;
                const moduleType = checkbox.dataset.type;
                let moduleData, url;

                if (moduleType === 'core') {
                    const selectedClass = classes.find(c => c.id === classId);
                    const docSnap = await db.collection('curriculums').doc(selectedClass.curriculumId).collection('modules').doc(moduleId).get();
                    moduleData = docSnap.data();
                    url = moduleData.type === 'vocab' ? `vocab_app.html?vocabId=${moduleId}` : `reading_test.html?testId=${moduleId}`;
                } else { // supplementary
                    moduleData = supplementaryModules.find(m => m.id === moduleId);
                    url = moduleData.type === 'vocab' ? `vocab_app.html?vocabId=${moduleId}` : `reading_test.html?testId=${moduleId}`;
                }
                
                modules.push({
                    title: moduleData.title,
                    type: moduleData.type,
                    url: url
                });
            }

            const assignmentData = {
                classId: classId,
                title: title,
                assignmentDate: firebase.firestore.FieldValue.serverTimestamp(),
                modules: modules
            };

            try {
                statusEl.textContent = `ƒêang t·∫°o b√†i t·∫≠p "${title}"...`;
                const docRef = await db.collection("assignments").add(assignmentData);
                statusEl.innerHTML += `<br>üéâ **TH√ÄNH C√îNG!** ƒê√£ t·∫°o b√†i t·∫≠p v·ªõi ID: ${docRef.id}`;
                alert('T·∫°o b√†i t·∫≠p th√†nh c√¥ng!');
            } catch (error) {
                statusEl.textContent = `L·ªói: ${error.message}`;
                console.error(error);
            }
        });
        
        document.getElementById('connect-btn').addEventListener('click', async (event) => {
            const connectButton = event.target;
            const form = document.getElementById('assignment-form');

            connectButton.disabled = true;
            connectButton.textContent = 'ƒêang k·∫øt n·ªëi...';

            if (initializeFirebase()) {
                await loadInitialData();
                form.disabled = false;
                connectButton.textContent = 'ƒê√£ k·∫øt n·ªëi & T·∫£i xong!';
                connectButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                connectButton.classList.add('bg-gray-400');
            } else {
                document.getElementById('status').textContent = 'K·∫øt n·ªëi th·∫•t b·∫°i.';
                connectButton.disabled = false;
                connectButton.textContent = 'Th·ª≠ l·∫°i';
            }
        });
    </script>
</body>
</html>
