<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Reading Test</title>
    <style>
        html { font-size: 15px; }
        :root {
            --panel-bg-color: rgba(255, 255, 255, 1);
            --glass-bg-color: rgba(255, 255, 255, 0.6);
            --glass-border-color: rgba(237, 242, 255, 0.9);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }
        body.dark {
            --panel-bg-color: rgba(30, 41, 59, 1);
            --glass-bg-color: rgba(29, 39, 58, 0.6);
            --glass-border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            margin: 0;
        }
        .exam-container { width: 100%; height: 100%; max-width: 1800px; position: relative; z-index: 1; display: flex; }
        .unified-panel { display: flex; flex-direction: column; width: 100%; height: 100%; border-radius: 16px; overflow: hidden; background: var(--panel-bg-color); border: 1px solid var(--glass-border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); }
        .glass-effect { background: var(--glass-bg-color); backdrop-filter: blur(8px) saturate(120%); -webkit-backdrop-filter: blur(8px) saturate(120%); }
        .btn { padding: 10px 22px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid transparent; transform: translateY(0); }
        .btn-main-action { background: var(--primary-accent); color: white; border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(91, 33, 182, 0.25); }
        .btn-main-action:hover { background: #5b21b6; transform: translateY(-3px); box-shadow: 0 7px 20px rgba(91, 33, 182, 0.4); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; opacity: 1; }
        .modal-content { padding: 24px; width: 90%; max-width: 500px; border-radius: 24px; text-align: center; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; justify-content: center; align-items: center; color: var(--primary-accent); font-size: 1.5rem; font-weight: bold; text-align: center; padding: 2rem; background: rgba(255, 255, 255, 0.8); }
        body.dark #loading-overlay { background: rgba(15, 23, 42, 0.8); }
        .input-modal .modal-content { max-width: 420px; padding: 32px; }
        .input-modal h2 { font-size: 1.75rem; color: var(--text-primary); margin-bottom: 8px; }
        .input-modal p { font-size: 1rem; color: var(--text-secondary); margin-bottom: 24px; }
        #code-inputs { display: flex; justify-content: center; gap: 10px; margin-bottom: 24px; }
        .code-input, #name-input { width: 100%; height: 60px; font-size: 1.5rem; text-align: center; border: 2px solid var(--glass-border-color); border-radius: 12px; background-color: rgba(0,0,0,0.05); color: var(--text-primary); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        .code-input { width: 50px; font-size: 2rem; }
        .code-input:focus, #name-input:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3); }
        .input-error { color: #ef4444; font-weight: 600; height: 20px; }
    </style>
</head>
<body>
    <div id="loading-overlay">Đang kết nối...</div>

    <div id="code-modal" class="modal input-modal">
        <div class="modal-content glass-effect">
            <h2>Nhập mã làm bài</h2>
            <p>Vui lòng nhập 6 ký tự trong mã được cung cấp để bắt đầu.</p>
            <div id="code-inputs">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
                <input type="text" class="code-input" maxlength="1" autocomplete="off">
            </div>
            <p id="code-error" class="input-error"></p>
        </div>
    </div>

    <div id="name-modal" class="modal input-modal">
        <div class="modal-content glass-effect">
            <h2>Xác nhận thông tin</h2>
            <p>Đây là một mã dự phòng. Vui lòng nhập họ và tên của bạn để tiếp tục.</p>
            <form id="name-modal-form">
                <input type="text" id="name-input" placeholder="Nguyễn Văn A" required>
                <button type="submit" class="btn btn-main-action" style="margin-top: 1rem;">Xác nhận</button>
            </form>
            <p id="name-error" class="input-error"></p>
        </div>
    </div>

    <div class="exam-container" style="display: none;"></div>
    
    <div id="result-modal" class="modal"></div>
    <div id="confirm-submit-modal" class="modal"></div>
    <div class="background-shapes"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCRaRV5JEwXlHWSPSrCYxyIIPjDWFMsV9A",
            authDomain: "ielts-foundation-6ea9d.firebaseapp.com",
            projectId: "ielts-foundation-6ea9d",
            storageBucket: "ielts-foundation-6ea9d.appspot.com",
            messagingSenderId: "296690693780",
            appId: "1:296690693780:web:f9a54a9ded68a73dcd2681",
            measurementId: "G-CZD89F0FC3"
        };
        
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyXIqam8Nx05Kn2_TZ7xWd5TkrH7PqdV_Qilwb0RheTVLzwTDxDR4BSOR60mD1BzZY0Fg/exec";

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlayEl = document.getElementById('loading-overlay');
            const examContainerEl = document.querySelector('.exam-container');
            const codeModalEl = document.getElementById('code-modal');
            const codeInputs = document.querySelectorAll('.code-input');
            const codeErrorEl = document.getElementById('code-error');
            const nameModalEl = document.getElementById('name-modal');
            const nameInputEl = document.getElementById('name-input');
            const nameModalForm = document.getElementById('name-modal-form');
            
            let currentUser = null;
            let currentTestId = null;
            let enteredCode = null;

            const RENDERERS = {
                multiple_choice_one_answer: block => `<p class="question-instruction">${block.instruction}</p>${block.items.map(item => `<div class="question-item" data-q-container="${item.qNum}"><p class="question-text"><b>${item.qNum}.</b> ${item.text}</p>${item.options.map((opt, i) => `<label class="mc-option"><input type="radio" name="q${item.qNum}" value="${i}"><span>${opt}</span></label>`).join('')}</div>`).join('')}`,
                true_false_not_given: block => `<p class="question-instruction">${block.instruction}</p>${block.items.map(item => `<div class="question-item" data-q-container="${item.qNum}"><p class="question-text"><b>${item.qNum}.</b> ${item.text}</p><div class="tfn-options">${['TRUE', 'FALSE', 'NOT GIVEN'].map(opt => `<label class="tfn-label"><input type="radio" name="q${item.qNum}" value="${opt}">${opt}</label>`).join('')}</div></div>`).join('')}`,
                sentence_completion: block => `<p class="question-instruction">${block.instruction}</p>${block.items.map(item => `<div class="question-item" data-q-container="${item.qNum}"><p class="question-text"><b>${item.qNum}.</b> ${item.text.replace(/______/g, `<input type="text" class="completion-input" data-q-num="${item.qNum}">`)}</p></div>`).join('')}`,
            };

            const mainApp = (examData) => {
                let userAnswers = {};
                let timerInterval;
                
                const submitTest = async () => {
                    clearInterval(timerInterval);
                    let score = 0;
                    questionDataMap.forEach((data, qNum) => {
                        const userAnswer = userAnswers[qNum];
                        if (userAnswer === undefined) return;
                        let isCorrect = String(userAnswer).trim().toLowerCase() === String(data.answer).toLowerCase();
                        if (isCorrect) score++;
                    });

                    document.getElementById('result-modal').innerHTML = `<div class="modal-content glass-effect"><h2>Hoàn thành!</h2><p>Điểm số của bạn:</p><p id="modal-score" style="font-size: 3rem; font-weight: 700; color: var(--primary-accent); margin: 20px 0;">${score} / ${questionDataMap.size}</p><button id="close-modal-btn" class="btn btn-main-action">Xem lại bài làm</button></div>`;
                    document.getElementById('result-modal').classList.add('show');

                    if (currentUser && currentTestId && enteredCode) {
                        db.collection("results").add({ studentUid: currentUser.uid, studentEmail: currentUser.email, studentName: currentUser.displayName || "", testId: currentTestId, codeUsed: enteredCode, answers: userAnswers, score: score, totalQuestions: questionDataMap.size, submittedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        
                        fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: "UPDATE_SCORE", code: enteredCode, score: score, totalQuestions: questionDataMap.size, studentEmail: currentUser.email, studentName: currentUser.displayName || "" }) }).catch(err => console.error("Lỗi gửi điểm đến Sheet:", err));
                    }
                };

                const initializeExam = () => {
                    examContainerEl.innerHTML = `<div class="unified-panel"><header class="exam-header glass-effect"><div class="header-left"><span>IELTS</span></div><div class="header-center" id="exam-title">Reading Test</div><div class="header-right"><div id="timer">60:00</div></div></header><main class="main-content"><div class="panel passage-panel" id="passage-panel"></div><div id="resizer"></div><div class="panel questions-panel" id="questions-panel"></div></main><footer class="exam-footer glass-effect"><div class="navigation-controls"><div id="navigation-pane" class="navigation-pane"></div><button id="submit-btn" class="btn btn-main-action">Nộp bài</button></div></footer></div>`;
                    
                    const questionDataMap = new Map();
                    document.getElementById('exam-title').innerText = examData.title || 'Reading Test';
                    let navHtml = '';
                    examData.questionBlocks.forEach(block => {
                        const passageNum = block.passage;
                        (block.items || Object.keys(block.answers || {})).forEach(item => {
                            const qNum = item.qNum || item;
                            navHtml += `<div class="nav-item" data-q-num="${qNum}" data-passage-num="${passageNum}">${qNum}</div>`;
                            questionDataMap.set(String(qNum), { answer: item.answer || block.answers[qNum], type: block.type });
                        });
                    });
                    
                    document.getElementById('navigation-pane').innerHTML = navHtml;
                    document.getElementById('passage-panel').innerHTML = examData.passages.map(p => `<div id="passage-container-${p.id}" style="display: none;">${p.content}</div>`).join('');
                    document.getElementById('questions-panel').innerHTML = examData.questionBlocks.map(block => `<div class="question-block" data-passage="${block.passage}" style="display: none;"><p class="question-range-title">Questions ${block.range}</p>${RENDERERS[block.type](block)}</div>`).join('');
                    
                    loadingOverlayEl.style.display = 'none';
                    examContainerEl.style.display = 'flex';
                    
                    let time = examData.timeLimitMinutes * 60;
                    const timerEl = document.getElementById('timer');
                    timerInterval = setInterval(() => {
                        if (--time < 0) { clearInterval(timerInterval); submitTest(); return; }
                        if(timerEl) timerEl.textContent = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`;
                    }, 1000);
                };

                initializeExam();
            };

            const promptForName = () => {
                return new Promise((resolve, reject) => {
                    nameModalEl.classList.add('show');
                    nameInputEl.focus();
                    nameModalForm.onsubmit = (e) => {
                        e.preventDefault();
                        const name = nameInputEl.value.trim();
                        if (name) {
                            resolve(name);
                        } else {
                            document.getElementById('name-error').innerText = "Vui lòng nhập họ và tên.";
                        }
                    };
                });
            };
            
            const validateAccessCodeAndStartExam = async (userCode) => {
                if (!userCode || userCode.length !== 6) return;
                
                loadingOverlayEl.style.display = 'flex';
                loadingOverlayEl.innerText = "Đang xác thực mã...";
                codeErrorEl.innerText = "";
                enteredCode = userCode.trim().toUpperCase();
                const testRef = db.collection("tests").doc(currentTestId);

                try {
                    const testData = await db.runTransaction(async (transaction) => {
                        const testDoc = await transaction.get(testRef);
                        if (!testDoc.exists) throw new Error("Bài thi không tồn tại.");
                        
                        const data = testDoc.data();
                        const codes = data.accessCodes || [];
                        const codeIndex = codes.findIndex(c => c.code === enteredCode);

                        if (codeIndex === -1) throw new Error("Mã làm bài không hợp lệ.");
                        if (codes[codeIndex].isUsed) throw new Error("Mã này đã được sử dụng.");

                        const codeInfo = codes[codeIndex];
                        let studentName = "";

                        if (codeInfo.studentEmail && codeInfo.studentEmail !== currentUser.email) {
                            throw new Error("Mã này không được gán cho tài khoản của bạn.");
                        }
                        
                        if (!codeInfo.studentEmail) {
                            codeModalEl.classList.remove('show');
                            studentName = await promptForName();
                            currentUser.displayName = studentName;
                            nameModalEl.classList.remove('show');
                        }
                        
                        const updatedCodes = [...codes];
                        updatedCodes[codeIndex].isUsed = true;
                        if (studentName) {
                            updatedCodes[codeIndex].studentEmail = currentUser.email;
                            updatedCodes[codeIndex].studentName = studentName;
                        }
                        transaction.update(testRef, { accessCodes: updatedCodes });
                        
                        return data;
                    });
                    
                    codeModalEl.classList.remove('show');
                    loadingOverlayEl.innerText = "Đang tải đề thi...";
                    mainApp(testData);

                } catch (error) {
                    loadingOverlayEl.style.display = 'none';
                    codeInputs.forEach(input => input.value = '');
                    codeInputs[0].focus();
                    codeErrorEl.innerText = error.message;
                }
            };
            
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    input.value = input.value.toUpperCase();
                    if (input.value && index < codeInputs.length - 1) { codeInputs[index + 1].focus(); }
                    const code = Array.from(codeInputs).map(i => i.value).join('');
                    if (code.length === 6) { validateAccessCodeAndStartExam(code); }
                });
                input.addEventListener('keydown', (e) => { if (e.key === "Backspace" && !input.value && index > 0) { codeInputs[index - 1].focus(); } });
            });

            auth.onAuthStateChanged(user => {
                if (isAuthCheckComplete) return;

                if (user) {
                    isAuthCheckComplete = true;
                    currentUser = user;
                    const urlParams = new URLSearchParams(window.location.search);
                    currentTestId = urlParams.get('testId');
                    if (currentTestId) {
                        loadingOverlayEl.style.display = 'none';
                        codeModalEl.classList.add('show');
                        codeInputs[0].focus();
                    } else {
                        loadingOverlayEl.innerText = "Lỗi: Không có bài thi nào được chọn.";
                    }
                } else {
                    isAuthCheckComplete = true;
                    window.location.href = 'index.html'; 
                }
            });
        });
    </script>
</body>
</html>
