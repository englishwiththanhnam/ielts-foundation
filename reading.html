<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Reading Test</title>
    <style>
        /* CSS GỐC GIỮ NGUYÊN */
        html { font-size: 15px; }
        :root {
            --panel-bg-color: rgba(255, 255, 255, 1);
            --glass-bg-color: rgba(255, 255, 255, 0.6);
            --glass-border-color: rgba(237, 242, 255, 0.9);
            --shadow-color: rgba(67, 56, 202, 0.15);
            --primary-accent: #6d28d9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --app-bg-start: #f5f7ff;
            --app-bg-end: #e0e7ff;
        }
        body.dark {
            --panel-bg-color: rgba(30, 41, 59, 1);
            --glass-bg-color: rgba(29, 39, 58, 0.6);
            --glass-border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.25);
            --primary-accent: #a78bfa;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --app-bg-start: #0f172a;
            --app-bg-end: #1e293b;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--app-bg-start);
            background-image: linear-gradient(135deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            margin: 0;
        }
        /* ... TOÀN BỘ CSS CŨ CỦA THẦY ... */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px); justify-content: center; align-items: center; opacity: 0; transform: scale(0.95); pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal.show { display: flex; opacity: 1; transform: scale(1); pointer-events: auto; }
        .modal-content { padding: 24px; width: 90%; max-width: 500px; border-radius: 24px; text-align: center; transition: transform 0.3s ease; transform: translateY(10px); }
        .modal.show .modal-content { transform: translateY(0); }

        /* === CSS MỚI CHO CỬA SỔ NHẬP MÃ === */
        #code-modal .modal-content {
            max-width: 420px;
            padding: 32px;
        }
        #code-modal h2 {
            font-size: 1.75rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        #code-modal p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        #code-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 24px;
        }
        .code-input {
            width: 50px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid var(--glass-border-color);
            border-radius: 12px;
            background-color: rgba(0,0,0,0.05);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .code-input:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3);
        }
        #code-error {
            color: #ef4444;
            font-weight: 600;
            height: 20px;
        }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; color: var(--primary-accent); font-size: 1.5rem; font-weight: bold; text-align: center; padding: 2rem; }
        body.dark #loading-overlay { background: rgba(15, 23, 42, 0.8); }
    </style>
</head>
<body>
    <!-- CỬA SỔ NHẬP MÃ MỚI -->
    <div id="code-modal" class="modal show">
        <div class="modal-content glass-effect">
            <h2>Nhập mã làm bài</h2>
            <p>Vui lòng nhập 6 ký tự trong mã được cung cấp để bắt đầu.</p>
            <div id="code-inputs">
                <input type="text" class="code-input" maxlength="1">
                <input type="text" class="code-input" maxlength="1">
                <input type="text" class="code-input" maxlength="1">
                <input type="text" class="code-input" maxlength="1">
                <input type="text" class="code-input" maxlength="1">
                <input type="text" class="code-input" maxlength="1">
            </div>
            <p id="code-error"></p>
        </div>
    </div>

    <div id="loading-overlay" style="display: none;">Đang tải...</div>

    <div class="exam-container" style="display: none;">
        <!-- Toàn bộ cấu trúc HTML của bài thi giữ nguyên -->
    </div>
    <!-- ... Các modal khác (result, confirm) giữ nguyên ... -->

    <!-- Tải các thư viện của Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
      const firebaseConfig = {
  apiKey: "AIzaSyBVuQrkh5XbEPykOl38P8mFmelkFn4dqV8",
  authDomain: "englishwiththanhnam.firebaseapp.com",
  projectId: "englishwiththanhnam",
  storageBucket: "englishwiththanhnam.firebasestorage.app",
  messagingSenderId: "443758150215",
  appId: "1:443758150215:web:379ee8bbcdae4d11e7e762"
};
        
        // !!! THẦY HÃY DÁN URL CỦA APPS SCRIPT WEB APP VÀO ĐÂY !!!
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyXIqam8Nx05Kn2_TZ7xWd5TkrH7PqdV_Qilwb0RheTVLzwTDxDR4BSOR60mD1BzZY0Fg/exec";

        // Khởi tạo Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // ... Tất cả các biến và hàm render giao diện gốc của thầy ...
            const loadingOverlayEl = document.getElementById('loading-overlay');
            const examContainerEl = document.querySelector('.exam-container');
            const codeModalEl = document.getElementById('code-modal');
            const codeInputs = document.querySelectorAll('.code-input');
            const codeErrorEl = document.getElementById('code-error');
            
            let currentUser = null;
            let currentTestId = null;
            let enteredCode = null;

            // --- LOGIC MỚI CHO CỬA SỔ NHẬP MÃ ---
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    }
                    const code = Array.from(codeInputs).map(i => i.value).join('');
                    if (code.length === 6) {
                        validateAccessCodeAndStartExam(code);
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === "Backspace" && !input.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text');
                    if (pasteData.length === 6) {
                        codeInputs.forEach((box, i) => box.value = pasteData[i] || '');
                        validateAccessCodeAndStartExam(pasteData);
                    }
                });
            });

            // --- CÁC HÀM XỬ LÝ CHÍNH ---
            const submitTest = async () => { /* ... Giữ nguyên như cũ ... */ };
            const initializeExam = (examData) => { /* ... Giữ nguyên như cũ ... */ };

            const validateAccessCodeAndStartExam = async (userCode) => {
                if (!userCode || userCode.length !== 6) return;
                
                loadingOverlayEl.style.display = 'flex';
                loadingOverlayEl.innerText = "Đang xác thực mã...";
                codeErrorEl.innerText = "";

                enteredCode = userCode.trim().toUpperCase();
                const testRef = db.collection("tests").doc(currentTestId);

                try {
                    const testData = await db.runTransaction(async (transaction) => {
                        const testDoc = await transaction.get(testRef);
                        if (!testDoc.exists) throw new Error("Bài thi không tồn tại.");
                        
                        const data = testDoc.data();
                        const codes = data.accessCodes || [];
                        const codeIndex = codes.findIndex(c => c.code === enteredCode);

                        if (codeIndex === -1) throw new Error("Mã làm bài không hợp lệ.");
                        if (codes[codeIndex].isUsed) throw new Error("Mã này đã được sử dụng.");

                        let studentName = "";
                        const codeInfo = codes[codeIndex];

                        if (codeInfo.studentEmail) {
                            if (codeInfo.studentEmail !== currentUser.email) {
                                throw new Error("Mã này không được gán cho tài khoản của bạn.");
                            }
                        } else {
                            studentName = prompt("Đây là một mã dự phòng. Vui lòng nhập họ và tên của bạn để tiếp tục:");
                            if (!studentName || studentName.trim() === "") throw new Error("Hủy bỏ do chưa nhập tên.");
                            currentUser.displayName = studentName.trim();
                        }
                        
                        const updatedCodes = [...codes];
                        updatedCodes[codeIndex].isUsed = true;
                        if (studentName) {
                            updatedCodes[codeIndex].studentEmail = currentUser.email;
                            updatedCodes[codeIndex].studentName = studentName.trim();
                        }
                        transaction.update(testRef, { accessCodes: updatedCodes });
                        
                        return data;
                    });
                    
                    codeModalEl.classList.remove('show');
                    loadingOverlayEl.innerText = "Đang tải đề thi...";
                    initializeExam(testData);

                } catch (error) {
                    loadingOverlayEl.style.display = 'none';
                    codeErrorEl.innerText = error.message;
                    codeInputs.forEach(input => input.value = '');
                    codeInputs[0].focus();
                }
            };
            
            // --- LOGIC CHÍNH KHI TẢI TRANG ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    const urlParams = new URLSearchParams(window.location.search);
                    currentTestId = urlParams.get('testId');

                    if (currentTestId) {
                        // Đã đăng nhập và có ID bài thi, không làm gì cả, chờ người dùng nhập mã
                        loadingOverlayEl.style.display = 'none'; // Ẩn màn hình loading ban đầu
                        codeModalEl.classList.add('show'); // Hiển thị cửa sổ nhập mã
                        codeInputs[0].focus();
                    } else {
                        loadingOverlayEl.innerText = "Lỗi: Không có bài thi nào được chọn.";
                        loadingOverlayEl.style.display = 'flex';
                    }
                } else {
                    window.location.href = 'index.html'; 
                }
            });
        });
    </script>
</body>
</html>
