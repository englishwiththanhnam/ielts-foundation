<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - English with Th√†nh Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover { background-color: #4f46e5; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .animate-scale-in { animation:scaleIn 0.2s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen bg-gray-200">
        <div class="fixed z-30 inset-y-0 left-0 w-64 bg-gray-800 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out">
            <div class="px-8 py-4">
                <h2 class="text-2xl font-semibold">Admin Panel</h2>
            </div>
            <nav class="mt-10">
                <a id="nav-assignments" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8 active">
                    <i class="fas fa-tasks mr-3"></i> Giao B√†i t·∫≠p
                </a>
                <a id="nav-upload" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8">
                    <i class="fas fa-upload mr-3"></i> T·∫£i l√™n H·ªçc ph·∫ßn
                </a>
                <a id="nav-students" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8">
                    <i class="fas fa-user-graduate mr-3"></i> Qu·∫£n l√Ω H·ªçc sinh
                </a>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white border-b-2 border-gray-200">
                <div>
                    <h1 id="page-title" class="text-2xl font-bold text-gray-800">Giao B√†i t·∫≠p</h1>
                </div>
                <div>
                    <span id="admin-name" class="mr-4"></span>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                </main>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // ===================================================================================
    // SECTION I: CORE & AUTH
    // ===================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCRaRV5JEwXlHWSPSrCYxyIIPjDWFMsV9A",
        authDomain: "ielts-foundation-6ea9d.firebaseapp.com",
        projectId: "ielts-foundation-6ea9d",
        storageBucket: "ielts-foundation-6ea9d.appspot.com",
        messagingSenderId: "296690693780",
        appId: "1:296690693780:web:f9a54a9ded68a73dcd2681"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const pageTitle = document.getElementById('page-title');
    const mainContent = document.getElementById('main-content');
    const adminName = document.getElementById('admin-name');
    const logoutButton = document.getElementById('logout-button');

    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().role === 'admin') {
                    adminName.textContent = user.displayName || user.email;
                    document.querySelector('#nav-assignments').click(); // M·∫∑c ƒë·ªãnh v√†o trang Giao b√†i t·∫≠p
                } else {
                    alert('T√†i kho·∫£n kh√¥ng c√≥ quy·ªÅn Admin.');
                    auth.signOut().finally(() => window.location.href = 'login.html');
                }
            });
        } else {
            window.location.href = 'login.html';
        }
    });

    // ===================================================================================
    // SECTION II: DATA PROCESSING HELPERS (from Vocab Tool)
    // ===================================================================================
    function processPastedDataForSave() {
        const words = (document.getElementById('col-word').value.trim() || '').split('\n');
        const types = (document.getElementById('col-type').value.trim() || '').split('\n');
        const pronunciations = (document.getElementById('col-pronunciation').value.trim() || '').split('\n');
        const meaningsVocab = (document.getElementById('col-meaning-vocab').value.trim() || '').split('\n');
        const structuresCombined = (document.getElementById('col-structures-combined').value.trim() || '').split('\n');
        
        const structures = structuresCombined.map(line => line.split('\t')[0] || '');
        const meaningsStructure = structuresCombined.map(line => line.split('\t')[1] || '');

        if (words.length === 1 && words[0] === '') return { vocabData: [], structureData: [] };
        if (words.length !== types.length || words.length !== pronunciations.length || words.length !== meaningsVocab.length) throw new Error("S·ªë d√≤ng trong c√°c c·ªôt t·ª´ v·ª±ng kh√¥ng kh·ªõp nhau!");
        if (structures.length === 1 && structures[0] !== '' && structures.length !== meaningsStructure.length) throw new Error("S·ªë d√≤ng trong c√°c c·ªôt c·∫•u tr√∫c kh√¥ng kh·ªõp nhau!");

        const vocabData = words.map((word, index) => ({ word: word.trim(), type: (types[index] || '').trim(), pronunciation: (pronunciations[index] || '').trim(), meaning: (meaningsVocab[index] || '').trim() }));
        const structureData = structures[0] === '' ? [] : structures.map((structure, index) => ({ 'text': structure.trim(), 'meaning': (meaningsStructure[index] || '').trim() }));
        return { vocabData, structureData };
    }

    function processDataSmartForSave(vocabData, structureData) {
        const structureGroups = structureData.reduce((acc, struct) => {
            if (!struct.text) return acc;
            let foundRoot = null;
            for (const vocabItem of vocabData) {
                if (!vocabItem.word) continue;
                const regex = new RegExp(`\\b${vocabItem.word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'i');
                if (regex.test(struct.text)) {
                    foundRoot = vocabItem.word;
                    break;
                }
            }
            if (foundRoot) {
                if (!acc[foundRoot]) acc[foundRoot] = [];
                acc[foundRoot].push(`${struct.text}: ${struct.meaning}`);
            }
            return acc;
        }, {});
        return vocabData.map((vocabItem, index) => ({ id: index + 1, word: vocabItem.word, type: vocabItem.type, pronunciation: vocabItem.pronunciation, meaning: vocabItem.meaning, structure: (structureGroups[vocabItem.word] || []).join('; ') }));
    }

    // ===================================================================================
    // SECTION III: MAIN RENDER FUNCTIONS
    // ===================================================================================

    /**
     * MODULE 1: Giao b√†i t·∫≠p (M·∫∑c ƒë·ªãnh)
     */
    async function renderAssignmentCreator() {
        pageTitle.textContent = 'Giao B√†i t·∫≠p';
        mainContent.innerHTML = `<p>ƒêang t·∫£i d·ªØ li·ªáu l·ªõp h·ªçc v√† h·ªçc ph·∫ßn...</p>`;
        
        try {
            const [classesSnap, modulesSnap] = await Promise.all([
                db.collection("classes").get(),
                db.collection("modules_content").get() // Collection m·ªõi ƒë·ªÉ l∆∞u h·ªçc ph·∫ßn
            ]);

            const classes = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const modules = modulesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const classOptions = classes.map(c => `<option value="${c.id}">${c.className}</option>`).join('');
            const moduleCheckboxes = modules.map(m => `
                <label class="flex items-center p-2 rounded hover:bg-gray-100">
                    <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded module-checkbox" value="${m.id}">
                    <span class="ml-3 text-sm text-gray-800">${m.title}</span>
                </label>
            `).join('');

            mainContent.innerHTML = `
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <div class="space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Th√¥ng tin B√†i t·∫≠p</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Giao cho l·ªõp:</label>
                                <select id="class-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">-- Ch·ªçn m·ªôt l·ªõp --</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label for="deadline-date" class="block text-sm font-medium text-gray-700 mb-1">H·∫°n ch√≥t (Deadline):</label>
                                <input type="date" id="deadline-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label>
                                <input type="text" id="assignment-title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: B√†i t·∫≠p v·ªÅ nh√† ng√†y ${new Date().toLocaleDateString('vi-VN')}">
                            </div>
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Ch·ªçn H·ªçc Ph·∫ßn ƒê·ªÉ Giao</h2>
                        <div class="space-y-2 p-4 bg-gray-50 rounded-md border h-72 overflow-y-auto">
                            ${moduleCheckboxes || '<p class="text-gray-500">Ch∆∞a c√≥ h·ªçc ph·∫ßn n√†o ƒë∆∞·ª£c t·∫£i l√™n.</p>'}
                        </div>
                    </div>
                    <button id="create-assignment-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all text-lg">
                        <i class="fas fa-paper-plane mr-2"></i> Giao B√†i T·∫≠p
                    </button>
                </div>
            </div>`;

            document.getElementById('create-assignment-btn').addEventListener('click', async () => {
                const classId = document.getElementById('class-selector').value;
                const title = document.getElementById('assignment-title').value.trim();
                const deadlineStr = document.getElementById('deadline-date').value;

                if (!classId || !title || !deadlineStr) {
                    return alert('Vui l√≤ng ch·ªçn l·ªõp, nh·∫≠p ti√™u ƒë·ªÅ v√† deadline.');
                }

                const deadline = firebase.firestore.Timestamp.fromDate(new Date(deadlineStr));
                const selectedModuleIds = Array.from(document.querySelectorAll('.module-checkbox:checked')).map(el => el.value);

                if (selectedModuleIds.length === 0) {
                    return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc ph·∫ßn ƒë·ªÉ giao.');
                }
                
                try {
                    await db.collection('assignments').add({
                        classId, title, deadline, moduleIds: selectedModuleIds, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Giao b√†i t·∫≠p th√†nh c√¥ng!');
                    document.getElementById('nav-assignments').click(); // Refresh l·∫°i trang
                } catch (error) {
                    console.error("L·ªói khi giao b√†i: ", error);
                    alert("ƒê√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            });

        } catch (error) {
            mainContent.innerHTML = `<p class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
        }
    }

    /**
     * MODULE 2: T·∫£i l√™n h·ªçc ph·∫ßn
     */
    function renderModuleUploader() {
        pageTitle.textContent = 'T·∫£i l√™n H·ªçc ph·∫ßn';
        mainContent.innerHTML = `
            <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold text-indigo-600 mb-2">C√¥ng c·ª• T·∫°o H·ªçc Ph·∫ßn T·ª´ V·ª±ng</h1>
                <p class="text-gray-600 mb-8">D·ªØ li·ªáu sau khi x·ª≠ l√Ω s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o kho h·ªçc ph·∫ßn chung.</p>
                <div class="space-y-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ c·ªßa H·ªçc ph·∫ßn:</label><input type="text" id="module-title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: Unit 1: Family Vocab"></div>
                    <div class="border-t pt-6"><h2 class="text-xl font-semibold text-gray-800 mb-4">D√°n d·ªØ li·ªáu T·ª´ v·ª±ng (T·ª´ng c·ªôt m·ªôt)</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label for="col-word" class="block text-sm font-medium text-gray-700 mb-1">C·ªôt 'Word'</label><textarea id="col-word" rows="12" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div><div><label for="col-type" class="block text-sm font-medium text-gray-700 mb-1">C·ªôt 'Type'</label><textarea id="col-type" rows="12" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div><div><label for="col-pronunciation" class="block text-sm font-medium text-gray-700 mb-1">C·ªôt 'Pronunciation'</label><textarea id="col-pronunciation" rows="12" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div><div><label for="col-meaning-vocab" class="block text-sm font-medium text-gray-700 mb-1">C·ªôt 'Meaning'</label><textarea id="col-meaning-vocab" rows="12" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div></div></div>
                    <div class="border-t pt-6"><h2 class="text-xl font-semibold text-gray-800 mb-4">D√°n d·ªØ li·ªáu C·∫•u tr√∫c (2 c·ªôt t·ª´ Excel/Sheets)</h2><textarea id="col-structures-combined" rows="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                    <button id="process-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all"><i class="fas fa-save mr-2"></i> L∆∞u v√†o Kho h·ªçc ph·∫ßn</button>
                    <div id="status" class="mt-4 p-4 bg-gray-50 rounded-md border border-gray-200 text-sm">Tr·∫°ng th√°i: S·∫µn s√†ng.</div>
                </div>
            </div>`;
        
        document.getElementById('process-btn').addEventListener('click', async () => {
            const title = document.getElementById('module-title').value.trim();
            const statusEl = document.getElementById('status');
            if (!title) return alert("Vui l√≤ng ƒëi·ªÅn Ti√™u ƒë·ªÅ c·ªßa h·ªçc ph·∫ßn.");
            
            try {
                const { vocabData, structureData } = processPastedDataForSave();
                if (vocabData.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ v·ª±ng.");

                statusEl.textContent = 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu th√¥ng minh...';
                const processedWords = processDataSmartForSave(vocabData, structureData);
                
                statusEl.textContent = 'ƒêang t·∫£i l√™n Firestore...';
                await db.collection('modules_content').add({
                    title: title,
                    type: 'vocab',
                    words: processedWords
                });
                
                statusEl.innerHTML = `üéâ <b>TH√ÄNH C√îNG!</b> ƒê√£ l∆∞u h·ªçc ph·∫ßn "${title}" v√†o kho.`;
                alert('T·∫£i l√™n h·ªçc ph·∫ßn th√†nh c√¥ng!');
                // X√≥a form ƒë·ªÉ chu·∫©n b·ªã cho l·∫ßn nh·∫≠p li·ªáu ti·∫øp theo
                document.getElementById('module-title').value = '';
                document.getElementById('col-word').value = '';
                document.getElementById('col-type').value = '';
                document.getElementById('col-pronunciation').value = '';
                document.getElementById('col-meaning-vocab').value = '';
                document.getElementById('col-structures-combined').value = '';

            } catch (error) {
                statusEl.textContent = `L·ªói: ${error.message}`;
                console.error(error);
            }
        });
    }

    /**
     * MODULE 3: Qu·∫£n l√Ω h·ªçc sinh
     */
    async function renderStudentManagement() {
        pageTitle.textContent = 'Qu·∫£n l√Ω H·ªçc sinh';
        mainContent.innerHTML = `<p>ƒêang t·∫£i danh s√°ch h·ªçc sinh...</p>`;

        try {
            const studentsSnap = await db.collection('users').where('role', '==', 'student').get();
            const students = studentsSnap.docs.map(doc => doc.data());

            const studentRows = students.map(s => `
                <tr class="border-b">
                    <td class="py-3 px-4 font-medium">${s.displayName || '(Ch∆∞a c√≥ t√™n)'}</td>
                    <td class="py-3 px-4">${s.email}</td>
                </tr>
            `).join('');

            mainContent.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="p-6">
                        <h2 class="text-xl font-bold">Danh s√°ch H·ªçc sinh (${students.length})</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-4">T√™n hi·ªÉn th·ªã</th>
                                    <th scope="col" class="py-3 px-4">Email</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentRows || '<tr><td colspan="2" class="p-4 text-center">Kh√¥ng c√≥ h·ªçc sinh n√†o.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        } catch (error) {
             mainContent.innerHTML = `<p class="text-red-500">L·ªói t·∫£i danh s√°ch h·ªçc sinh: ${error.message}</p>`;
        }
    }

    // ===================================================================================
    // SECTION IV: EVENT LISTENERS
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // --- Sidebar & Logout ---
        logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));
        
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                const nav = e.currentTarget;
                nav.classList.add('active');
                
                const navId = nav.id;
                if (navId === 'nav-assignments') renderAssignmentCreator();
                else if (navId === 'nav-upload') renderModuleUploader();
                else if (navId === 'nav-students') renderStudentManagement();
            });
        });
    });
</script>
</body>
</html>
