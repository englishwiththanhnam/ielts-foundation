<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - English with Th√†nh Nam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }

        /* --- Sidebar & Common --- */
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover { background-color: #4f46e5; color: white; }
        .sidebar-link.active { background-color: #4f46e5; color: white; font-weight: 600; }
        .list-item:hover { background-color: #f3f4f6; }
        .list-item.active { background-color: #eef2ff; border-color: #6366f1; }

        /* --- Curriculum Tree --- */
        .tree-container ul {
            padding-left: 20px;
            border-left: 1px dashed #ccc;
        }
        .tree-container li {
            list-style-type: none;
            position: relative;
        }
        .tree-node {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        .tree-node:hover {
            background-color: #f3f4f6;
        }
        .tree-node-main {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .tree-node .toggle-icon {
            margin-right: 8px;
            width: 16px;
            display: inline-block;
            text-align: center;
            transition: transform 0.2s;
        }
        .tree-node.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .tree-container .nested-list {
            display: block;
        }
        .tree-container .nested-list.hidden {
            display: none;
        }
        .context-menu-trigger {
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .tree-node:hover .context-menu-trigger {
            opacity: 1;
        }
        .context-menu-trigger:hover {
            background-color: #e5e7eb;
        }

        /* --- Animation --- */
        .animate-scale-in { animation:scaleIn 0.2s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen bg-gray-200">
        <div class="fixed z-30 inset-y-0 left-0 w-64 bg-gray-800 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out">
            <div class="px-8 py-4">
                <h2 class="text-2xl font-semibold">Admin Panel</h2>
            </div>
            <nav class="mt-10">
                <a id="nav-content" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8 active">
                    <i class="fas fa-book mr-3"></i> Qu·∫£n L√Ω Gi√°o Tr√¨nh
                </a>
                <a id="nav-classes" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8">
                    <i class="fas fa-school mr-3"></i> Qu·∫£n L√Ω L·ªõp H·ªçc
                </a>
                <a id="nav-students" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8">
                    <i class="fas fa-user-graduate mr-3"></i> Qu·∫£n L√Ω H·ªçc Sinh
                </a>
                <a id="nav-assignments" href="#" class="sidebar-link mt-1 flex items-center py-2 px-8">
                    <i class="fas fa-tasks mr-3"></i> Giao B√†i T·∫≠p
                </a>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white border-b-2 border-gray-200">
                <div>
                    <h1 id="page-title" class="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω Gi√°o Tr√¨nh</h1>
                </div>
                <div>
                    <span id="admin-name" class="mr-4"></span>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                </main>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // ===================================================================================
    // SECTION I: CORE & AUTH
    // ===================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCRaRV5JEwXlHWSPSrCYxyIIPjDWFMsV9A",
        authDomain: "ielts-foundation-6ea9d.firebaseapp.com",
        projectId: "ielts-foundation-6ea9d",
        storageBucket: "ielts-foundation-6ea9d.appspot.com",
        messagingSenderId: "296690693780",
        appId: "1:296690693780:web:f9a54a9ded68a73dcd2681"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const pageTitle = document.getElementById('page-title');
    const mainContent = document.getElementById('main-content');
    const adminName = document.getElementById('admin-name');
    const logoutButton = document.getElementById('logout-button');

    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().role === 'admin') {
                    adminName.textContent = user.displayName || user.email;
                    document.querySelector('#nav-content').click(); // M·∫∑c ƒë·ªãnh v√†o trang qu·∫£n l√Ω gi√°o tr√¨nh
                } else {
                    alert('T√†i kho·∫£n kh√¥ng c√≥ quy·ªÅn Admin.');
                    auth.signOut().finally(() => window.location.href = 'login.html');
                }
            });
        } else {
            window.location.href = 'login.html';
        }
    });

    // ===================================================================================
    // SECTION II: UI HELPERS
    // ===================================================================================
    function showInputModal(title, label, defaultValue = '', callback) {
        document.getElementById('input-modal')?.remove();
        const modalHTML = `
            <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md animate-scale-in">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <label class="block mb-2 text-sm font-medium">${label}</label>
                    <input id="modal-input-field" type="text" class="w-full p-2 border rounded" value="${defaultValue}">
                    <div class="mt-4 flex justify-end gap-2">
                        <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                        <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded">X√°c nh·∫≠n</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        const modal = document.getElementById('input-modal');
        const inputField = document.getElementById('modal-input-field');
        inputField.focus();
        inputField.select();

        const closeModal = () => modal.remove();
        document.getElementById('modal-confirm-btn').onclick = () => { callback(inputField.value); closeModal(); };
        document.getElementById('modal-cancel-btn').onclick = closeModal;
    }

    function showModuleTypeModal(callback) {
        document.getElementById('module-type-modal')?.remove();
        const modalHTML = `
            <div id="module-type-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md animate-scale-in">
                    <h3 class="text-lg font-bold mb-4">Ch·ªçn lo·∫°i h·ªçc ph·∫ßn</h3>
                    <div class="space-y-3">
                       <button data-type="vocab" class="w-full text-left p-3 border rounded hover:bg-gray-100">üìñ T·ª´ v·ª±ng</button>
                       <button data-type="exam" class="w-full text-left p-3 border rounded hover:bg-gray-100 cursor-not-allowed opacity-50" disabled>‚úçÔ∏è ƒê·ªÅ thi (S·∫Øp ra m·∫Øt)</button>
                    </div>
                    <div class="mt-4 flex justify-end">
                         <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById('module-type-modal');
        modal.querySelectorAll('button[data-type]').forEach(btn => {
            if (btn.disabled) return;
            btn.onclick = () => { callback(btn.dataset.type); modal.remove(); }
        });
        document.getElementById('modal-cancel-btn').onclick = () => modal.remove();
    }

    // ===================================================================================
    // SECTION III: DATA PROCESSING HELPERS (from Vocab Tool)
    // ===================================================================================
    function processPastedDataForSave() {
        const words = (document.getElementById('col-word').value.trim() || '').split('\n');
        const types = (document.getElementById('col-type').value.trim() || '').split('\n');
        const pronunciations = (document.getElementById('col-pronunciation').value.trim() || '').split('\n');
        const meaningsVocab = (document.getElementById('col-meaning-vocab').value.trim() || '').split('\n');
        const structuresCombined = (document.getElementById('col-structures-combined').value.trim() || '').split('\n');
        
        const structures = structuresCombined.map(line => line.split('\t')[0] || '');
        const meaningsStructure = structuresCombined.map(line => line.split('\t')[1] || '');

        if (words.length === 1 && words[0] === '') return { vocabData: [], structureData: [] };

        if (words.length !== types.length || words.length !== pronunciations.length || words.length !== meaningsVocab.length) {
            throw new Error("S·ªë d√≤ng trong c√°c c·ªôt t·ª´ v·ª±ng kh√¥ng kh·ªõp nhau!");
        }
        if (structures.length === 1 && structures[0] !== '' && structures.length !== meaningsStructure.length) {
             throw new Error("S·ªë d√≤ng trong c√°c c·ªôt c·∫•u tr√∫c kh√¥ng kh·ªõp nhau!");
        }

        const vocabData = words.map((word, index) => ({ word: word.trim(), type: (types[index] || '').trim(), pronunciation: (pronunciations[index] || '').trim(), meaning: (meaningsVocab[index] || '').trim() }));
        const structureData = structures[0] === '' ? [] : structures.map((structure, index) => ({ 'text': structure.trim(), 'meaning': (meaningsStructure[index] || '').trim() }));
        return { vocabData, structureData };
    }

    function processDataSmartForSave(vocabData, structureData) {
        const structureGroups = structureData.reduce((acc, struct) => {
            if (!struct.text) return acc;
            let foundRoot = null;
            for (const vocabItem of vocabData) {
                if (!vocabItem.word) continue;
                const regex = new RegExp(`\\b${vocabItem.word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'i');
                if (regex.test(struct.text)) {
                    foundRoot = vocabItem.word;
                    break;
                }
            }
            if (foundRoot) {
                if (!acc[foundRoot]) acc[foundRoot] = [];
                acc[foundRoot].push(`${struct.text}: ${struct.meaning}`);
            }
            return acc;
        }, {});

        return vocabData.map((vocabItem, index) => ({
            id: index + 1,
            word: vocabItem.word,
            type: vocabItem.type,
            pronunciation: vocabItem.pronunciation,
            meaning: vocabItem.meaning,
            structure: (structureGroups[vocabItem.word] || []).join('; ')
        }));
    }

    // ===================================================================================
    // SECTION IV: FIRESTORE CRUD HELPERS
    // ===================================================================================
    async function handleAddItem(type, parentId, parentName) {
        if (type === 'unit') {
            showInputModal(`Th√™m Unit m·ªõi v√†o "${parentName}"`, 'T√™n Unit:', '', async (newUnitName) => {
                if (!newUnitName.trim()) return;
                const unitCountSnap = await db.collection('new_units').where('curriculumId', '==', parentId).get();
                await db.collection('new_units').add({
                    name: newUnitName.trim(),
                    curriculumId: parentId,
                    order: unitCountSnap.size + 1
                });
                renderContentManagement();
            });
        } else if (type === 'module') {
            showModuleTypeModal((moduleType) => {
                if (moduleType === 'vocab') renderVocabCreator(parentId);
            });
        }
    }

    async function handleRenameItem(type, id, oldName) {
        showInputModal(`ƒê·ªïi t√™n cho "${oldName}"`, 'T√™n m·ªõi:', oldName, async (newName) => {
            if (!newName.trim() || newName.trim() === oldName) return;
            const collectionName = type === 'curriculum' ? 'new_curriculums' : (type === 'unit' ? 'new_units' : 'new_modules');
            const fieldToUpdate = type === 'module' ? 'title' : 'name';
            await db.collection(collectionName).doc(id).update({ [fieldToUpdate]: newName.trim() });
            renderContentManagement();
        });
    }

    async function handleDeleteItem(type, id, name) {
        if (!confirm(`B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA "${name}"?\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn m·ª•c n√†y v√† T·∫§T C·∫¢ c√°c m·ª•c con b√™n trong. KH√îNG TH·ªÇ HO√ÄN T√ÅC.`)) return;
        
        try {
            if (type === 'curriculum') await deleteCurriculum(id);
            else if (type === 'unit') await deleteUnit(id);
            else if (type === 'module') await deleteModule(id);
            alert(`ƒê√£ x√≥a "${name}" th√†nh c√¥ng.`);
            renderContentManagement();
        } catch (error) {
            console.error(`L·ªói khi x√≥a ${type}:`, error);
            alert(`C√≥ l·ªói x·∫£y ra khi x√≥a: ${error.message}`);
        }
    }

    async function deleteModule(moduleId) {
        const moduleDoc = await db.collection('new_modules').doc(moduleId).get();
        if (!moduleDoc.exists) return;
        const { type, contentId } = moduleDoc.data();
        
        if (type === 'vocab' && contentId) await db.collection('vocab_sets').doc(contentId).delete();
        await db.collection('new_modules').doc(moduleId).delete();
    }

    async function deleteUnit(unitId) {
        const modulesSnap = await db.collection('new_modules').where('unitId', '==', unitId).get();
        const deletePromises = modulesSnap.docs.map(doc => deleteModule(doc.id));
        await Promise.all(deletePromises);
        await db.collection('new_units').doc(unitId).delete();
    }

    async function deleteCurriculum(curriculumId) {
        const unitsSnap = await db.collection('new_units').where('curriculumId', '==', curriculumId).get();
        const deletePromises = unitsSnap.docs.map(doc => deleteUnit(doc.id));
        await Promise.all(deletePromises);
        await db.collection('new_curriculums').doc(curriculumId).delete();
    }

    // ===================================================================================
    // SECTION V: MAIN RENDER FUNCTIONS
    // ===================================================================================

    // -----------------------------------------------------------------------------------
    // MODULE 1: CONTENT MANAGEMENT
    // -----------------------------------------------------------------------------------
    async function renderContentManagement() {
        pageTitle.textContent = 'Qu·∫£n L√Ω Gi√°o Tr√¨nh';
        mainContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                <div id="content-tree-panel" class="md:col-span-1 bg-white rounded-lg shadow p-4 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">C·∫•u tr√∫c Gi√°o tr√¨nh</h2><button id="add-curriculum-btn" class="px-3 py-1 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700"><i class="fas fa-plus mr-1"></i> M·ªõi</button></div>
                    <div id="tree-container" class="tree-container overflow-y-auto flex-grow"><p>ƒêang t·∫£i...</p></div>
                </div>
                <div id="content-detail-panel" class="md:col-span-2 bg-white rounded-lg shadow p-6"><p class="text-gray-500">Ch·ªçn m·ªôt m·ª•c t·ª´ c√¢y th∆∞ m·ª•c ho·∫∑c t·∫°o m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p></div>
            </div>`;

        try {
            const [curriculumsSnap, unitsSnap, modulesSnap] = await Promise.all([
                db.collection('new_curriculums').orderBy('name').get(),
                db.collection('new_units').orderBy('order').get(),
                db.collection('new_modules').orderBy('order').get()
            ]);

            const curriculums = curriculumsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const units = unitsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const modules = modulesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const curriculumMap = new Map(curriculums.map(c => [c.id, { ...c, units: [] }]));
            const unitMap = new Map(units.map(u => [u.id, { ...u, modules: [] }]));

            modules.forEach(m => { if (unitMap.has(m.unitId)) unitMap.get(m.unitId).modules.push(m); });
            units.forEach(u => { if (curriculumMap.has(u.curriculumId)) curriculumMap.get(u.curriculumId).units.push(unitMap.get(u.id)); });
            
            const treeContainer = document.getElementById('tree-container');
            if (curriculumMap.size === 0) {
                treeContainer.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ gi√°o tr√¨nh n√†o. Nh·∫•n "M·ªõi" ƒë·ªÉ t·∫°o.</p>';
                return;
            }

            let treeHtml = '<ul>';
            for (const curriculum of curriculumMap.values()) {
                let unitsHtml = '<ul class="nested-list">';
                for (const unit of curriculum.units) {
                    let modulesHtml = '<ul class="nested-list">';
                    for (const module of unit.modules) {
                        const moduleIcon = module.type === 'vocab' ? 'üìñ' : 'üìÑ';
                        modulesHtml += `<li><div class="tree-node" data-id="${module.id}" data-type="module" data-content-id="${module.contentId}" data-module-type="${module.type}"><div class="tree-node-main"><span class="node-name">${moduleIcon} ${module.title}</span></div><button class="context-menu-trigger"><i class="fas fa-ellipsis-h"></i></button></div></li>`;
                    }
                    modulesHtml += '</ul>';
                    unitsHtml += `<li><div class="tree-node" data-id="${unit.id}" data-type="unit"><div class="tree-node-main"><span class="toggle-icon"><i class="fas fa-caret-down"></i></span><span class="node-name">üìÑ ${unit.name}</span></div><button class="context-menu-trigger"><i class="fas fa-ellipsis-h"></i></button></div>${modulesHtml}</li>`;
                }
                unitsHtml += '</ul>';
                treeHtml += `<li><div class="tree-node" data-id="${curriculum.id}" data-type="curriculum"><div class="tree-node-main"><span class="toggle-icon"><i class="fas fa-caret-down"></i></span><span class="node-name">üìÅ ${curriculum.name}</span></div><button class="context-menu-trigger"><i class="fas fa-ellipsis-h"></i></button></div>${unitsHtml}</li>`;
            }
            treeHtml += '</ul>';
            treeContainer.innerHTML = treeHtml;

        } catch (error) {
            console.error("L·ªói khi d·ª±ng c√¢y th∆∞ m·ª•c:", error);
            document.getElementById('tree-container').innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i c·∫•u tr√∫c gi√°o tr√¨nh.</p>';
        }
    }

    function renderVocabCreator(unitId) {
        const detailPanel = document.getElementById('content-detail-panel');
        detailPanel.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">T·∫°o H·ªçc ph·∫ßn T·ª´ v·ª±ng m·ªõi</h2>
            <div class="space-y-4"><input type="text" id="vocab-title" class="w-full p-2 border rounded font-semibold" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ h·ªçc ph·∫ßn..."><div class="grid grid-cols-1 md:grid-cols-4 gap-2"><div><label class="text-sm font-medium">Word</label><textarea id="col-word" rows="12" class="w-full p-2 border rounded text-sm"></textarea></div><div><label class="text-sm font-medium">Type</label><textarea id="col-type" rows="12" class="w-full p-2 border rounded text-sm"></textarea></div><div><label class="text-sm font-medium">Pronunciation</label><textarea id="col-pronunciation" rows="12" class="w-full p-2 border rounded text-sm"></textarea></div><div><label class="text-sm font-medium">Meaning</label><textarea id="col-meaning-vocab" rows="12" class="w-full p-2 border rounded text-sm"></textarea></div></div><div><label class="block text-sm font-medium">C·∫•u tr√∫c/Idioms (D√°n c·∫£ 2 c·ªôt t·ª´ Excel/Sheets v√†o ƒë√¢y)</label><textarea id="col-structures-combined" rows="8" class="w-full p-2 border rounded text-sm"></textarea></div><div class="flex justify-end gap-2"><button id="cancel-creation-btn" class="px-6 py-2 bg-gray-200 rounded">H·ªßy</button><button id="save-new-vocab-btn" class="px-6 py-2 bg-green-600 text-white rounded">L∆∞u h·ªçc ph·∫ßn</button></div></div>`;
    }

    async function renderVocabEditor(moduleId, contentId) {
        const detailPanel = document.getElementById('content-detail-panel');
        detailPanel.innerHTML = `<p>ƒêang t·∫£i tr√¨nh ch·ªânh s·ª≠a...</p>`;
        try {
            const doc = await db.collection('vocab_sets').doc(contentId).get();
            if (!doc.exists) throw new Error('Kh√¥ng t√¨m th·∫•y n·ªôi dung h·ªçc ph·∫ßn.');
            const data = doc.data();
            const words = data.words || [];

            const wordsCol = words.map(w => w.word || '').join('\n');
            const typesCol = words.map(w => w.type || '').join('\n');
            const pronunciationsCol = words.map(w => w.pronunciation || '').join('\n');
            const meaningsVocabCol = words.map(w => w.meaning || '').join('\n');
            let combinedStructures = [];
            words.forEach(word => { if(word.structure) { word.structure.split(';').forEach(s => { if(s.trim()) combinedStructures.push(s.trim().replace(': ', '\t')); }); } });

            detailPanel.innerHTML = `<h2 class="text-2xl font-bold mb-4">S·ª≠a H·ªçc ph·∫ßn T·ª´ v·ª±ng</h2><div class="space-y-4"><input type="text" id="vocab-title" class="w-full p-2 border rounded font-semibold" value="${data.title}"><div class="grid grid-cols-1 md:grid-cols-4 gap-2"><div><label class="text-sm font-medium">Word</label><textarea id="col-word" rows="12" class="w-full p-2 border rounded text-sm">${wordsCol}</textarea></div><div><label class="text-sm font-medium">Type</label><textarea id="col-type" rows="12" class="w-full p-2 border rounded text-sm">${typesCol}</textarea></div><div><label class="text-sm font-medium">Pronunciation</label><textarea id="col-pronunciation" rows="12" class="w-full p-2 border rounded text-sm">${pronunciationsCol}</textarea></div><div><label class="text-sm font-medium">Meaning</label><textarea id="col-meaning-vocab" rows="12" class="w-full p-2 border rounded text-sm">${meaningsVocabCol}</textarea></div></div><div><label class="block text-sm font-medium">C·∫•u tr√∫c/Idioms (D√°n c·∫£ 2 c·ªôt t·ª´ Excel/Sheets v√†o ƒë√¢y)</label><textarea id="col-structures-combined" rows="8" class="w-full p-2 border rounded text-sm">${combinedStructures.join('\n')}</textarea></div><div class="flex justify-end gap-2"><button id="cancel-edit-btn" class="px-6 py-2 bg-gray-200 rounded">H·ªßy</button><button id="update-vocab-btn" class="px-6 py-2 bg-blue-600 text-white rounded">L∆∞u thay ƒë·ªïi</button></div></div>`;
        } catch (error) {
            detailPanel.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
        }
    }

    // -----------------------------------------------------------------------------------
    // MODULE 2: CLASS MANAGEMENT
    // -----------------------------------------------------------------------------------
    async function renderClassManagement() {
        pageTitle.textContent = 'Qu·∫£n L√Ω L·ªõp H·ªçc';
        mainContent.innerHTML = `<p>ƒêang t·∫£i...</p>`;

        const [classesSnap, curriculumsSnap] = await Promise.all([
            db.collection('classes').get(),
            db.collection('new_curriculums').get()
        ]);
        const classes = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const curriculums = curriculumsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let classListHtml = classes.map(c => `<div class="list-item border-l-4 border-transparent p-3 cursor-pointer" data-class-id="${c.id}"><p class="font-bold text-gray-800">${c.className}</p></div>`).join('');
        let curriculumOptions = curriculums.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

        mainContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full"><div class="md:col-span-1 bg-white rounded-lg shadow p-4 flex flex-col h-full"><h2 class="text-xl font-bold mb-4">Danh s√°ch L·ªõp h·ªçc</h2><div class="mb-4"><input id="new-class-name" class="w-full p-2 border rounded mb-2" placeholder="T√™n l·ªõp m·ªõi..."><select id="new-class-curriculum" class="w-full p-2 border rounded mb-2"><option value="">-- Ch·ªçn gi√°o tr√¨nh --</option>${curriculumOptions}</select><button id="add-class-btn" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">Th√™m L·ªõp M·ªõi</button></div><div id="class-list" class="overflow-y-auto flex-grow">${classListHtml}</div></div><div id="class-detail" class="md:col-span-2 bg-white rounded-lg shadow p-6"><p class="text-gray-500">Ch·ªçn m·ªôt l·ªõp h·ªçc ƒë·ªÉ xem chi ti·∫øt.</p></div></div>`;
    }

    async function renderClassDetail(classId) {
        const detailView = document.getElementById('class-detail');
        detailView.innerHTML = `<p>ƒêang t·∫£i chi ti·∫øt l·ªõp h·ªçc...</p>`;

        const [classDoc, studentsSnap] = await Promise.all([
            db.collection('classes').doc(classId).get(),
            db.collection('users').where('role', '==', 'student').get()
        ]);
        const classData = { id: classDoc.id, ...classDoc.data() };
        const allStudents = studentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const studentsInClass = allStudents.filter(s => s.enrolledClasses?.includes(classId));
        const studentsNotInClass = allStudents.filter(s => !s.enrolledClasses?.includes(classId));

        let studentsInClassHtml = studentsInClass.map(s => `<tr><td class="py-2 pr-4">${s.displayName}</td><td class="py-2 pr-4">${s.email}</td><td class="text-right"><button class="remove-student-btn text-red-500 text-sm" data-student-id="${s.id}" data-class-id="${classId}">X√≥a</button></td></tr>`).join('');
        let studentsNotInClassHtml = studentsNotInClass.map(s => `<tr><td class="py-2 pr-4">${s.displayName}</td><td class="py-2 pr-4">${s.email}</td><td class="text-right"><button class="add-student-btn text-green-500 text-sm" data-student-id="${s.id}" data-class-id="${classId}">Th√™m</button></td></tr>`).join('');

        detailView.innerHTML = `<div class="flex justify-between items-start"><h2 class="text-2xl font-bold mb-6">${classData.className}</h2><button id="delete-class-btn" class="text-red-500 hover:text-red-700" data-id="${classId}"><i class="fas fa-trash-alt"></i> X√≥a L·ªõp</button></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2">H·ªçc sinh trong l·ªõp (${studentsInClass.length})</h3><table class="w-full text-sm">${studentsInClassHtml}</table></div><div><h3 class="font-semibold mb-2">H·ªçc sinh ch∆∞a c√≥ trong l·ªõp</h3><table class="w-full text-sm">${studentsNotInClassHtml}</table></div></div>`;
    }

    // -----------------------------------------------------------------------------------
    // MODULE 3: STUDENT MANAGEMENT
    // -----------------------------------------------------------------------------------
    async function renderStudentManagement() {
        pageTitle.textContent = 'Qu·∫£n L√Ω H·ªçc Sinh';
        mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-600">Module n√†y ƒëang trong qu√° tr√¨nh ph√°t tri·ªÉn.</p></div>`;
    }

    // -----------------------------------------------------------------------------------
    // MODULE 4: ASSIGNMENT MANAGEMENT
    // -----------------------------------------------------------------------------------
    async function renderAssignmentManagement() {
        pageTitle.textContent = 'Giao B√†i T·∫≠p';
        mainContent.innerHTML = `<p>ƒêang t·∫£i...</p>`;

        const classesSnap = await db.collection("classes").get();
        const classes = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let classOptions = classes.map(c => `<option value="${c.id}" data-curriculum-id="${c.curriculumId}">${c.className}</option>`).join('');
        
        mainContent.innerHTML = `<div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-lg"><div class="space-y-6"><div><h2 class="text-xl font-semibold text-gray-800 mb-4">1. Th√¥ng tin B√†i t·∫≠p</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><label for="class-selector" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn l·ªõp h·ªçc:</label><select id="class-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"><option value="">-- Ch·ªçn m·ªôt l·ªõp --</option>${classOptions}</select></div><div class="md:col-span-2"><label for="assignment-title" class="block text-sm font-medium text-gray-700 mb-1">Ti√™u ƒë·ªÅ b√†i t·∫≠p:</label><input type="text" id="assignment-title" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="V√≠ d·ª•: B√†i t·∫≠p v·ªÅ nh√† ${new Date().toLocaleDateString('vi-VN')}"></div></div></div><div class="border-t pt-6"><h2 class="text-xl font-semibold text-gray-800 mb-4">2. Ch·ªçn H·ªçc Ph·∫ßn ƒê·ªÉ Giao</h2><div id="core-modules-container" class="space-y-2 p-4 bg-gray-50 rounded-md border h-72 overflow-y-auto"><p class="text-gray-500">Vui l√≤ng ch·ªçn m·ªôt l·ªõp h·ªçc ƒë·ªÉ xem c√°c h·ªçc ph·∫ßn.</p></div></div><button id="create-assignment-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all text-lg">T·∫°o B√†i T·∫≠p</button></div></div>`;
    }

    // ===================================================================================
    // SECTION VI: EVENT LISTENERS
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // --- Sidebar & Logout ---
        logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                const nav = e.currentTarget;
                nav.classList.add('active');
                const navId = nav.id;
                if (navId === 'nav-classes') renderClassManagement();
                else if (navId === 'nav-students') renderStudentManagement();
                else if (navId === 'nav-content') renderContentManagement();
                else if (navId === 'nav-assignments') renderAssignmentManagement();
            });
        });

        // --- Main Content Event Delegation ---
        mainContent.addEventListener('click', async (e) => {
            // -- For Content Management --
            const trigger = e.target.closest('.context-menu-trigger');
            if (e.target.closest('#add-curriculum-btn')) {
                showInputModal('T·∫°o Gi√°o tr√¨nh m·ªõi', 'T√™n Gi√°o tr√¨nh', '', async (name) => {
                    if (name.trim()) await db.collection('new_curriculums').add({ name: name.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    renderContentManagement();
                });
            } else if (trigger) {
                e.stopPropagation();
                const parentNode = trigger.closest('.tree-node');
                const id = parentNode.dataset.id;
                const type = parentNode.dataset.type;
                const name = parentNode.querySelector('.node-name').textContent.trim();
                
                document.getElementById('tree-context-menu')?.remove();
                let menuItems = '';
                if (type === 'curriculum') menuItems = `<li data-action="add-unit">‚ûï Th√™m Unit</li><li data-action="rename">‚úèÔ∏è ƒê·ªïi t√™n</li><li data-action="delete" class="text-red-600 hover:bg-red-100">üóëÔ∏è X√≥a</li>`;
                else if (type === 'unit') menuItems = `<li data-action="add-module">‚ûï Th√™m H·ªçc ph·∫ßn</li><li data-action="rename">‚úèÔ∏è ƒê·ªïi t√™n</li><li data-action="delete" class="text-red-600 hover:bg-red-100">üóëÔ∏è X√≥a</li>`;
                else if (type === 'module') menuItems = `<li data-action="edit-content">‚úèÔ∏è S·ª≠a n·ªôi dung</li><li data-action="rename">‚úèÔ∏è ƒê·ªïi t√™n</li><li data-action="delete" class="text-red-600 hover:bg-red-100">üóëÔ∏è X√≥a</li>`;

                const menu = document.createElement('ul');
                menu.id = 'tree-context-menu';
                menu.className = 'absolute bg-white shadow-lg rounded-md p-1 text-sm z-20';
                menu.style.left = `${e.pageX}px`;
                menu.style.top = `${e.pageY}px`;
                menu.innerHTML = menuItems.split('<li').slice(1).map(item => `<li class="cursor-pointer px-3 py-1.5 rounded" ${item}`).join('');
                document.body.appendChild(menu);
                menu.querySelectorAll('li').forEach(item => {
                    item.onclick = () => {
                        const action = item.dataset.action;
                        if (action === 'add-unit') handleAddItem('unit', id, name);
                        else if (action === 'add-module') handleAddItem('module', id, name);
                        else if (action === 'rename') handleRenameItem(type, id, name);
                        else if (action === 'delete') handleDeleteItem(type, id, name);
                        else if (action === 'edit-content' && parentNode.dataset.moduleType === 'vocab') renderVocabEditor(id, parentNode.dataset.contentId);
                        menu.remove();
                    };
                });
            } else if (e.target.closest('.tree-node')) {
                const node = e.target.closest('.tree-node');
                if (e.target.closest('.toggle-icon')) {
                    const nestedList = node.nextElementSibling;
                    if (nestedList?.tagName === 'UL') {
                        nestedList.classList.toggle('hidden');
                        node.classList.toggle('collapsed');
                    }
                } else if (e.target.closest('.tree-node-main')) {
                    document.querySelectorAll('.tree-node').forEach(n => n.style.backgroundColor = 'transparent');
                    node.style.backgroundColor = '#eef2ff';
                    const type = node.dataset.type;
                    const id = node.dataset.id;
                    if (type === 'module' && node.dataset.moduleType === 'vocab') renderVocabEditor(id, node.dataset.contentId);
                    else document.getElementById('content-detail-panel').innerHTML = `<p>ƒê√£ ch·ªçn <b>${type.toUpperCase()}</b>: ${node.querySelector('.node-name').textContent.trim()}</p><p>ID: ${id}</p>`;
                }
            }
            
            // -- For Class Management --
            else if (e.target.closest('.list-item[data-class-id]')) {
                 document.querySelectorAll('.list-item[data-class-id]').forEach(el => el.classList.remove('active'));
                 const item = e.target.closest('.list-item[data-class-id]');
                 item.classList.add('active');
                 renderClassDetail(item.dataset.classId);
            } else if (e.target.matches('#add-class-btn')) {
                const className = document.getElementById('new-class-name').value.trim();
                const curriculumId = document.getElementById('new-class-curriculum').value;
                if (!className || !curriculumId) return alert('Vui l√≤ng nh·∫≠p t√™n l·ªõp v√† ch·ªçn gi√°o tr√¨nh.');
                await db.collection('classes').add({ className, curriculumId });
                renderClassManagement();
            } else if (e.target.matches('#delete-class-btn')) {
                const classId = e.target.dataset.id;
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp h·ªçc n√†y?')) {
                    await db.collection('classes').doc(classId).delete();
                    renderClassManagement();
                }
            } else if (e.target.matches('.add-student-btn, .remove-student-btn')) {
                const studentId = e.target.dataset.studentId;
                const classId = e.target.dataset.classId;
                const isAdding = e.target.classList.contains('add-student-btn');
                const operation = isAdding ? firebase.firestore.FieldValue.arrayUnion : firebase.firestore.FieldValue.arrayRemove;
                await db.collection('users').doc(studentId).update({ enrolledClasses: operation(classId) });
                renderClassDetail(classId);
            }

            // -- For Assignment Management --
            else if (e.target.matches('#create-assignment-btn')) {
                const classId = document.getElementById('class-selector').value;
                const title = document.getElementById('assignment-title').value.trim();
                if (!classId || !title) return alert('Vui l√≤ng ch·ªçn l·ªõp v√† nh·∫≠p ti√™u ƒë·ªÅ b√†i t·∫≠p.');
                
                const selectedModules = [];
                document.querySelectorAll('#core-modules-container input[type="checkbox"]:checked').forEach(el => {
                    selectedModules.push({ id: el.value, title: el.dataset.moduleTitle, type: el.dataset.moduleType });
                });
                
                if(selectedModules.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc ph·∫ßn ƒë·ªÉ giao.');

                await db.collection('assignments').add({
                    classId, title, modules: selectedModules, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Giao b√†i t·∫≠p th√†nh c√¥ng!');
                document.getElementById('nav-assignments').click();
            }

            // --- Handlers inside dynamically created content ---
            else if (e.target.matches('#save-new-vocab-btn, #cancel-creation-btn, #update-vocab-btn, #cancel-edit-btn')) {
                // These are handled by their own `.onclick` inside their render functions
            }
        });

        mainContent.addEventListener('change', async (e) => {
            // -- For Assignment Management --
            if (e.target.id === 'class-selector') {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const curriculumId = selectedOption.dataset.curriculumId;
                const coreContainer = document.getElementById('core-modules-container');
                if (!curriculumId) {
                    coreContainer.innerHTML = '<p class="text-gray-500">L·ªõp n√†y ch∆∞a c√≥ gi√°o tr√¨nh.</p>';
                    return;
                }
                coreContainer.innerHTML = '<p>ƒêang t·∫£i h·ªçc ph·∫ßn...</p>';
                
                const unitsSnap = await db.collection('new_units').where('curriculumId', '==', curriculumId).orderBy('order').get();
                const unitIds = unitsSnap.docs.map(doc => doc.id);
                if (unitIds.length === 0) {
                     coreContainer.innerHTML = '<p class="text-gray-500">Gi√°o tr√¨nh c·ªßa l·ªõp n√†y ch∆∞a c√≥ unit n√†o.</p>';
                     return;
                }

                const modulesSnap = await db.collection('new_modules').where('unitId', 'in', unitIds).orderBy('order').get();
                const units = unitsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const modules = modulesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let coreHtml = '';
                units.forEach(unit => {
                    coreHtml += `<div class="font-semibold text-gray-700 mt-3 first:mt-0">${unit.name}</div>`;
                    const unitModules = modules.filter(m => m.unitId === unit.id);
                    if (unitModules.length > 0) {
                        coreHtml += unitModules.map(module => `
                            <label class="flex items-center p-2 rounded hover:bg-gray-100 ml-2">
                                <input type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" value="${module.contentId}" data-module-title="${module.title}" data-module-type="${module.type}">
                                <span class="ml-3 text-sm text-gray-800">${module.title}</span>
                            </label>
                        `).join('');
                    } else {
                        coreHtml += `<p class="text-xs text-gray-400 ml-4">Ch∆∞a c√≥ h·ªçc ph·∫ßn</p>`;
                    }
                });
                coreContainer.innerHTML = coreHtml || '<p class="text-gray-500">Gi√°o tr√¨nh n√†y ch∆∞a c√≥ h·ªçc ph·∫ßn n√†o.</p>';
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu-trigger') && !e.target.closest('#tree-context-menu')) {
                document.getElementById('tree-context-menu')?.remove();
            }
        });
    });
</script>
</body>
</html>
