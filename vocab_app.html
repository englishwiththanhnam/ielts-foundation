<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- PH·∫¶N HEAD GI·ªÆ NGUY√äN T·ª™ FILE TEMPLATE.HTML C·ª¶A B·∫†N -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc ph·∫ßn T·ª´ v·ª±ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PH·∫¶N STYLE GI·ªÆ NGUY√äN T·ª™ FILE TEMPLATE.HTML C·ª¶A B·∫†N -->
    <style>
        /* D√°n to√†n b·ªô n·ªôi dung th·∫ª <style> t·ª´ file template.html c·ªßa b·∫°n v√†o ƒë√¢y */
        :root { --blur-intensity: 12px; /* ... */ }
        /* ... */
        .fade-in { animation: fadeIn 0.5s ease forwards; }
    </style>
</head>
<body>
    <!-- PH·∫¶N BODY GI·ªÆ NGUY√äN T·ª™ FILE TEMPLATE.HTML C·ª¶A B·∫†N -->
    <div class="background-shapes">
        <!-- ... -->
    </div>
    <div class="app-layout">
        <nav id="sidebar" class="glass-panel">
            <!-- ... -->
        </nav>
        <div id="sidebar-overlay"></div>
        <main id="app">
            <header class="main-header">
                <!-- ... -->
            </header>
            <div id="main-content">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c render b·ªüi JS -->
            </div>
        </main>
    </div>
    <!-- C√°c Modal c≈©ng gi·ªØ nguy√™n -->
    <div id="word-list-modal" class="modal">
        <!-- ... -->
    </div>

    <!-- [THAY ƒê·ªîI QUAN TR·ªåNG] SCRIPT T√çCH H·ª¢P FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script type="module">
        // --- PH·∫¶N 1: K·∫æT N·ªêI FIREBASE ---
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let assignmentId, vocabId, userId;

        // --- PH·∫¶N 2: LOGIC APP T·ª™ V·ª∞NG C·ª¶A B·∫†N ---
        // To√†n b·ªô ƒë·ªëi t∆∞·ª£ng App t·ª´ file template.html s·∫Ω ƒë∆∞·ª£c d√°n v√†o ƒë√¢y
        const App = {
            data: {
                // ...
            },

            // [S·ª¨A ƒê·ªîI] H√†m init() ƒë·ªÉ t√≠ch h·ª£p Firebase
            async init() {
                this.initTheme();
                this.initModals();
                this.initSidebarNav();
                this.initResponsiveSidebar();

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        userId = user.uid;
                        const urlParams = new URLSearchParams(window.location.search);
                        assignmentId = urlParams.get('assignmentId');
                        vocabId = urlParams.get('vocabId');

                        if (!assignmentId || !vocabId) {
                            document.getElementById('main-content').innerHTML = `<h1>L·ªói: URL kh√¥ng h·ª£p l·ªá.</h1>`;
                            return;
                        }
                        
                        // [M·ªöI] T·∫£i d·ªØ li·ªáu t·ª´ Firestore thay v√¨ localStorage
                        await this.loadDataFromFirestore();
                        this.renderDashboard();

                    } else {
                        window.location.href = 'login.html';
                    }
                });
            },

            // [S·ª¨A ƒê·ªîI] H√†m loadData() th√†nh loadDataFromFirestore()
            async loadDataFromFirestore() {
                // 1. T·∫£i b·ªô t·ª´ v·ª±ng g·ªëc t·ª´ collection 'vocab_sets'
                const vocabSetDoc = await db.collection('vocab_sets').doc(vocabId).get();
                if (!vocabSetDoc.exists) {
                    console.error("Kh√¥ng t√¨m th·∫•y b·ªô t·ª´ v·ª±ng!");
                    return;
                }
                const vocabSetData = vocabSetDoc.data();
                const originalWords = vocabSetData.words;

                // 2. T·∫£i ti·∫øn ƒë·ªô c·ªßa h·ªçc sinh t·ª´ 'student_progress'
                const progressDoc = await db.collection('student_progress').doc(userId).collection('assignments').doc(assignmentId).get();
                const progressData = progressDoc.exists ? progressDoc.data().vocabProgress?.[vocabId] : null;

                if (progressData) {
                    // N·∫øu c√≥ ti·∫øn ƒë·ªô, h·ª£p nh·∫•t n√≥ v·ªõi d·ªØ li·ªáu g·ªëc
                    this.data.words = progressData.words;
                    this.data.skippedItems = progressData.skippedItems || [];
                } else {
                    // N·∫øu ch∆∞a c√≥, kh·ªüi t·∫°o t·ª´ d·ªØ li·ªáu g·ªëc
                    this.data.words = originalWords.map(w => ({ ...w, isLearned: false }));
                    this.data.skippedItems = [];
                }

                // C√°c b∆∞·ªõc x·ª≠ l√Ω d·ªØ li·ªáu kh√°c gi·ªØ nguy√™n
                this.analyzeAndTagWords(); 
                this.groupWordFamilies();
                this.parseAndStoreStructures();
                // [M·ªöI] C·∫≠p nh·∫≠t l·∫°i isLearned cho structures d·ª±a tr√™n progress
                if (progressData && progressData.structures) {
                    this.data.structures.forEach(s => {
                        const savedStruct = progressData.structures.find(ps => ps.id === s.id);
                        if (savedStruct) {
                            s.isLearned = savedStruct.isLearned;
                        }
                    });
                }
            },

            // [S·ª¨A ƒê·ªîI] H√†m saveData() ƒë·ªÉ l∆∞u v√†o Firestore
            async saveData() {
                if (!userId || !assignmentId || !vocabId) return;

                const progressRef = db.collection('student_progress').doc(userId).collection('assignments').doc(assignmentId);
                const progressPayload = {
                    [`vocabProgress.${vocabId}`]: {
                        words: this.data.words,
                        structures: this.data.structures,
                        skippedItems: this.data.skippedItems,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                };
                
                // D√πng set v·ªõi merge:true ƒë·ªÉ t·∫°o ho·∫∑c c·∫≠p nh·∫≠t document
                await progressRef.set(progressPayload, { merge: true });
            },
            
            // [M·ªöI] H√†m ho√†n th√†nh h·ªçc ph·∫ßn
            async markModuleAsCompleted() {
                const progressRef = db.collection('student_progress').doc(userId).collection('assignments').doc(assignmentId);
                const moduleUrl = `vocab_app.html?vocabId=${vocabId}&assignmentId=${assignmentId}`;
                await progressRef.set({
                    completedModules: {
                        [moduleUrl]: true
                    }
                }, { merge: true });
                window.location.href = `assignment.html?id=${assignmentId}`;
            },

            // ... C√°c h√†m kh√°c c·ªßa App (renderDashboard, renderMCQ, v.v...) gi·ªØ nguy√™n ...
            // Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o h√†m init() v√† saveData() ƒë∆∞·ª£c s·ª≠a ƒë·ªïi nh∆∞ tr√™n.
            // Th√™m m·ªôt n√∫t "Ho√†n th√†nh" ·ªü ƒë√¢u ƒë√≥, v√≠ d·ª• trong Dashboard khi t·∫•t c·∫£ t·ª´ ƒë√£ h·ªçc.
            renderDashboard() {
                // ... code render dashboard c≈© ...
                const allLearned = this.data.words.every(w => w.isLearned) && this.data.structures.every(s => s.isLearned);
                if (allLearned) {
                    main.innerHTML += `<div class="text-center mt-8"><button id="complete-module-btn" class="btn btn-main-action">üéâ Ho√†n th√†nh & Quay l·∫°i</button></div>`;
                    document.getElementById('complete-module-btn').addEventListener('click', () => this.markModuleAsCompleted());
                }
            }
        };

        App.init();
    </script>
</body>
</html>
